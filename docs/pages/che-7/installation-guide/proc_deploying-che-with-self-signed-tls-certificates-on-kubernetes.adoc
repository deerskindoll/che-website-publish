// Module included in the following assemblies:
//
// installing-{prod-id-short}-in-tls-mode-with-self-signed-certificates

[id="deploying-{prod-id-short}-with-self-signed-tls-certificates-on-kubernetes_{context}"]
= Deploying {prod-short} with self-signed TLS certificates on Kubernetes

This section describes how to deploy {prod-short} on Kubernetes (including Minikube) with self-signed TLS certificates.

By default, {prod-short} is deployed on Kubernetes infratructures with a self-signed certificate that is generated automatically during the {prod-short} installation process. No additional prerequisites for the deployment exist.

To deploy {prod-short} with a self-signed certificate generated by the user, create a {orch-namespace} for {prod-short} before the deployment and  two secrets in it:

* The TLS secret: `che-tls`, which holds the server TLS certificate and key (using the `tls.crt` and `tls.key` files). This secret is signed by the self-signed CA certificate. `che-tls` is the default name of the {prod-short} server TLS secret. This can be changed in the configuration.

* The public part of the self-signed CA certificate: `self-signed-certificate`, an opaque secret (based on the `ca.crt` key).

To deploy {prod-short} with a commonly trusted TLS certificate, it is required to create a single `che-tls` secret in the corresponding {orch-namespace}.

WARNING: When intending to use a commonly trusted TLS certificate for the {prod-short} deployment, do not create the `self-signed-certificate` secret. {prod-short} detects that data from the `che-tls` secret does not match and replaces both secrets with autogenerated data.


.Prerequisites

* A running Kubernetes instance, version 1.9 or higher.
* All required keys and certificates. See xref:generating-self-signed-tls-certificates_{context}[].


.Procedure

. Pre-create a {orch-namespace} for {prod-short}:
+
[subs="+quotes,attributes"]
----
$ kubectl create namespace {prod-namespace}
----

. Create a secret with the domain key and the certificate:
+
[subs="+quotes,attributes"]
----
$ kubectl create secret tls che-tls --key=domain.key --cert=domain.crt -n {prod-namespace}
----

. Create a secret from the CA certificate:
+
[subs="+quotes,attributes"]
----
$ kubectl create secret generic self-signed-certificate --from-file=ca.crt -n {prod-namespace}
----

. Deploy {prod-short} using `{prod-cli}`:
+
[subs="+quotes,attributes"]
----
$ {prod-cli} server:start --platform=k8s
----
+
When using Minikube, substitute `k8s` in the above command with `minikube`.


.Additional resources

* xref:importing-self-signed-tls-certificates-to-browsers_{context}[]
