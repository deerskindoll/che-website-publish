<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" dev docs">
<title>SPI&#58 Implementation | Eclipse Che Documentation</title>
<link rel="stylesheet" href="css/syntax.css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="css/theme-che.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="che" href="http://0.0.0.0:4000/feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Eclipse Che Documentation</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->




                
                
                
                <li><a href="release-6.0.0.html">Release Notes</a></li>
                
                
                
                <li><a href="https://github.com/eclipse/che" target="_blank">Source Code</a></li>
                
                
                
                <li><a href="https://www.eclipse.org/che/docs/5/che/docs" target="_blank">Docs 5.x</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Get Support<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="https://github.com/eclipse/che/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc+label%3Akind%2Fbug" target="_blank">Known Bugs</a></li>
                        
                        
                        
                        <li><a href="https://github.com/eclipse/che/issues/new" target="_blank">File an Issue</a></li>
                        
                        
                        
                        <li><a href="https://stackoverflow.com/questions/tagged/eclipse-che" target="_blank">Che on StackOverflow</a></li>
                        
                        
                    </ul>
                </li>
                
                
                <!-- 
			<li>



  <a class="email" title="Submit feedback" href="#" onclick="javascript:window.location='mailto:?subject= feedback&body=I have some feedback about the SPI&#58 Implementation page: ' + window.location.href;"><i class="fa fa-envelope-o"></i> Feedback</a>

</li>
 -->
		
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="SPI&amp;#58 Implementation">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
  <li class="sidebarTitle"> </li>
  
  
  
      
  
  <li>
      <a href="#">Overview</a>
      <ul>
          
          
          
          <li><a href="index.html">Introduction</a></li>
          
          
          
          
          
          
          <li><a href="quick-start.html">Getting Started</a></li>
          
          
          
          
          
          
          <li><a href="single-multi-user.html">Single and Multi-User Flavors</a></li>
          
          
          
          
          
          
          <li><a href="infra-support.html">Supported Infrastructures</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Che on Docker</a>
      <ul>
          
          
          
          <li><a href="docker-single-user.html">Docker - Single User</a></li>
          
          
          
          
          
          
          <li><a href="docker-multi-user.html">Docker - Multi User</a></li>
          
          
          
          
          
          
          <li><a href="docker-config.html">Docker - Configuration</a></li>
          
          
          
          
          
          
          <li><a href="docker-cli.html">Docker - CLI Reference</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Che on OpenShift</a>
      <ul>
          
          
          
          <li><a href="openshift-single-user.html">OpenShift - Single User</a></li>
          
          
          
          
          
          
          <li><a href="openshift-multi-user.html">OpenShift - Multi User</a></li>
          
          
          
          
          
          
          <li><a href="openshift-config.html">OpenShift - Configuration</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">User Management</a>
      <ul>
          
          
          
          <li><a href="user-management.html">Authentication and Authorization</a></li>
          
          
          
          
          
          
          <li><a href="authentication.html">Security Model</a></li>
          
          
          
          
          
          
          <li><a href="permissions.html">Permissions</a></li>
          
          
          
          
          
          
          <li><a href="organizations.html">Organizations in UD</a></li>
          
          
          
          
          
          
          <li><a href="resource-management.html">Resource Management</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">User Guides</a>
      <ul>
          
          
          
          <li><a href="creating-starting-workspaces.html">Creating and starting Workspaces</a></li>
          
          
          
          
          
          
          <li><a href="ide-projects.html">Projects</a></li>
          
          
          
          
          
          
          <li><a href="editor-code-assistance.html">Editor and Code-Assistance</a></li>
          
          
          
          
          
          
          <li><a href="dependency-management.html">Dependency Management</a></li>
          
          
          
          
          
          
          <li><a href="commands-ide-macro.html">Commands and IDE Macros</a></li>
          
          
          
          
          
          
          <li><a href="version-control.html">Version Control</a></li>
          
          
          
          
          
          
          <li><a href="debug.html">Debug</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Workspace Administration</a>
      <ul>
          
          
          
          <li><a href="what-are-workspaces.html">Workspace Overview</a></li>
          
          
          
          
          
          
          <li><a href="stacks.html">Stacks</a></li>
          
          
          
          
          
          
          <li><a href="recipes.html">Workspace - Recipes</a></li>
          
          
          
          
          
          
          <li><a href="servers.html">Workspace - Servers</a></li>
          
          
          
          
          
          
          <li><a href="installers.html">Workspace - Installers</a></li>
          
          
          
          
          
          
          <li><a href="volumes.html">Workspace - Volumes Mount</a></li>
          
          
          
          
          
          
          <li><a href="env-variables.html">Workspace - Environment Variables</a></li>
          
          
          
          
          
          
          <li><a href="projects.html">Workspace - Projects</a></li>
          
          
          
          
          
          
          <li><a href="workspaces-troubleshooting.html">Workspace - Troubleshooting</a></li>
          
          
          
          
          
          
          <li><a href="workspace-data-model.html">Workspace Data Model</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Portable Workspaces</a>
      <ul>
          
          
          
          <li><a href="chedir-getting-started.html">Chedir - Getting Started</a></li>
          
          
          
          
          
          
          <li><a href="why-chedir.html">Chedir - Why Chedir?</a></li>
          
          
          
          
          
          
          <li><a href="chedir-installation.html">Chedir - Installation</a></li>
          
          
          
          
          
          
          <li><a href="chedir-project-setup.html">Chedir - Project Setup</a></li>
          
          
          
          
          
          
          <li><a href="chedir-up-and-down.html">Chedir - Up and Down</a></li>
          
          
          
          
          
          
          <li><a href="chefile.html">Chedir - Chefile</a></li>
          
          
          
          
          
          
          <li><a href="chedir-ssh.html">Chedir - SSH</a></li>
          
          
          
          
          
          
          <li><a href="factories-getting-started.html">Factory - Getting Started</a></li>
          
          
          
          
          
          
          <li><a href="creating-factories.html">Factory - Creating</a></li>
          
          
          
          
          
          
          <li><a href="factories_json_reference.html">Factory - JSON Reference</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Developer Guides</a>
      <ul>
          
          
          
          <li><a href="framework-overview.html">Overview</a></li>
          
          
          
          
          
          
          <li><a href="rest-api.html">SDK - REST API</a></li>
          
          
          
          
          
          
          <li><a href="che-in-che-quickstart.html">SDK - Your First Plugin</a></li>
          
          
          
          
          
          
          <li><a href="build-reqs.html">SDK - Building Che</a></li>
          
          
          
          
          
          
          <li><a href="assemblies.html">SDK - Assemblies</a></li>
          
          
          
          
          
          
          <li><a href="ide-extensions-gwt.html">SDK - GWT IDE Extensions</a></li>
          
          
          
          
          
          
          <li><a href="ide-extensions-js.html">SDK - JavaScript IDE Extensions</a></li>
          
          
          
          
          
          
          <li><a href="server-side-extensions.html">SDK - Server Side Extensions</a></li>
          
          
          
          
          
          
          <li><a href="custom_installers.html">SDK - Installers</a></li>
          
          
          
          
          
          
          <li><a href="project-types.html">SDK - Project Types</a></li>
          
          
          
          
          
          
          <li><a href="parts.html">IDE UI&#58 Parts</a></li>
          
          
          
          
          
          
          <li><a href="actions.html">IDE UI&#58 Actions</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Dev Essentials</a>
      <ul>
          
          
          
          <li><a href="guice.html">Dependency Injection</a></li>
          
          
          
          
          
          
          <li><a href="dto.html">Transport&#58 DTO</a></li>
          
          
          
          
          
          
          <li><a href="json-rpc.html">Communication&#58 JSON-RPC</a></li>
          
          
          
          
          
          
          <li><a href="handling-projects-in-plugins.html">Handling Projects in Plugins</a></li>
          
          
          
          
          
          
          <li><a href="dao.html">Persistence, DAO</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Infrastructure and SPI</a>
      <ul>
          
          
          
          <li><a href="spi_overview.html">Overview</a></li>
          
          
          
          
          
          
          <li class="active"><a href="spi-implementation.html">Implementation Notes</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block:
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
         -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>

            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">SPI&#58 Implementation</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.
$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2' });
/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top
  $(window).scrollTop(scroll_target - 10);
  return false
})

});
</script>

<div id="toc"></div>

    


    <!-- 


     -->

  <p>Now that you have made yourself familiar with <a href="spi_overview.html">SPI motivation and concept</a>, let’s take a closer look at its components and implementation notes.</p>

<h2 id="components">Components</h2>

<h3 id="environment">Environment</h3>

<ul>
  <li>
    <p><a href="https://github.com/eclipse/che/blob/master/wsmaster/che-core-api-workspace/src/main/java/org/eclipse/che/api/workspace/server/spi/environment/InternalEnvironment.java#L32">InternalEnvironment</a> holds internal representations of environment configuration.</p>
  </li>
  <li>
    <p><a href="https://github.com/eclipse/che/blob/master/wsmaster/che-core-api-workspace/src/main/java/org/eclipse/che/api/workspace/server/spi/environment/InternalEnvironmentFactory.java#L45">InternalEnvironmentFactory</a> creates a valid <code class="highlighter-rouge">InternalEnvironment</code> based on the specified workspace configuration and recipe. This component is independent of Infrastructure</p>
  </li>
</ul>

<h3 id="infrastructure">Infrastructure</h3>

<ul>
  <li><a href="https://github.com/eclipse/che/blob/master/wsmaster/che-core-api-workspace/src/main/java/org/eclipse/che/api/workspace/server/spi/RuntimeInfrastructure.java">RuntimeInfrastructure</a> is a starting point that has two obligations:
    <ul>
      <li>provides meta information about infrastructure like name and types of supported recipes;</li>
      <li>provides an interface for creation of <code class="highlighter-rouge">RuntimeContext</code>.</li>
    </ul>
  </li>
  <li>
    <p><a href="https://github.com/eclipse/che/blob/master/wsmaster/che-core-api-workspace/src/main/java/org/eclipse/che/api/workspace/server/spi/RuntimeContext.java">RuntimeContext</a> holds information that can be used by <code class="highlighter-rouge">InternalRuntime</code>.</p>
  </li>
  <li><a href="https://github.com/eclipse/che/blob/master/wsmaster/che-core-api-workspace/src/main/java/org/eclipse/che/api/workspace/server/spi/InternalRuntime.java">InternalRuntime</a> describes particular runtime and provides an interface for interacting with it like starting, stopping.</li>
</ul>

<p>Environment components are decoupled from Infrastructure components to make it easier to support the same environments type by different infrastructures.</p>

<p>The following diagram shows the components interaction while a workspace start.</p>

<figure><img class="docimage" src="images/spi/start-sequence-diagram.png" alt="" /></figure>

<h2 id="exceptions">Exceptions</h2>

<p>There are three types of exceptions which can be thrown by Infrastructure components:</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">ValidationException</code> should be thrown when an error occurs because of wrong data provided by user (e.g. recipe);</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">InternalInfrastructureException</code> should be thrown when an unexpected error occurs and a user has no ways of fixing it, so Che Server administrator should take a look at it;</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">InfrastructureException</code> should be thrown in all other cases.</p>
  </li>
</ul>

<h2 id="events">Events</h2>

<p>Infrastructure should inform Workspace API about progress of starting/stopping a workspace with publishing of events. Events are <a href="dto.html">DTOs objects</a> and can be created with <code class="highlighter-rouge">DtoFactory</code>. Server implementations are provided by <a href="https://github.com/eclipse/che/tree/master/wsmaster/che-core-api-workspace">workspace-api</a> module. Infrastructure should publish them by <code class="highlighter-rouge">EventService</code>. Information about particular events and when they should be thrown are listed below.</p>

<h2 id="internalenvironmentfactory">InternalEnvironmentFactory</h2>

<p>The first thing that should be decided is which environments will be supported by a new infrastructure, and which recipes this environment supports. Che has four recipes out of the box which can be used: <code class="highlighter-rouge">dockerfile</code>, <code class="highlighter-rouge">dockerimage</code>, <code class="highlighter-rouge">compose</code>, <code class="highlighter-rouge">openshift</code>. If a developer wants to support own recipe type the corresponding <code class="highlighter-rouge">InternalEnvironmentFactory</code> should be bound with a <code class="highlighter-rouge">MapBinder</code> with unique String key that contains recipe type, like:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="n">MapBinder</span><span class="o">.</span><span class="na">newMapBinder</span><span class="o">(</span><span class="n">binder</span><span class="o">(),</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">InternalEnvironmentFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                    <span class="o">.</span><span class="na">addBinding</span><span class="o">(</span><span class="s">"myRecipe"</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">SubclassOfInternalEnvironmentFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div>

<p>Once supported environments are taken care of, the next step is implementing own <code class="highlighter-rouge">RuntimeInfrastructure, RuntimeContext, InternalRuntime</code> which are strongly connected.</p>

<h2 id="runtimeinfrastructure">RuntimeInfrastructure</h2>

<p>So, <code class="highlighter-rouge">RuntimeInfrastructure</code> should create <code class="highlighter-rouge">RuntimeContext</code> according to the specified <code class="highlighter-rouge">InternalEnvironment</code>. Before context creation, <code class="highlighter-rouge">RuntimeInfrastructure</code> may somehow need to customize <code class="highlighter-rouge">InternalEnvironment</code>, like modifying original recipes objects according to machines configuration (e.g. exposing ports required for configured servers, or setting memory limit according to machine configuration). This step is called <strong>Runtime Context preparing</strong>.</p>

<h2 id="runtimecontext">RuntimeContext</h2>

<p><strong>Implementation of RuntimeContext</strong> should provide two methods:</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">#getOutputChannel</code> method that returns an output channel for a particular runtime. The output channel is a WebSocket endpoint where runtime output can be received by clients. Infrastructure can set up own endpoint or use an existing one.</p>

    <p>Existing master websocket endpoint is configured with <code class="highlighter-rouge">che.websocket.endpoint</code> property. Out of the box, there is <code class="highlighter-rouge">installer/log</code> request handler that will publish received event via EventService and two <a href="json-rpc.html">JSON RPC</a> messengers which transmit <a href="https://github.com/eclipse/che/blob/master/wsmaster/che-core-api-workspace-shared/src/main/java/org/eclipse/che/api/workspace/shared/dto/event/InstallerLogEvent.java">InstallerLogEvent</a> and <a href="https://github.com/eclipse/che/blob/master/wsmaster/che-core-api-workspace-shared/src/main/java/org/eclipse/che/api/workspace/shared/dto/event/MachineLogEvent.java">MachineLogEvent</a> via WebSocket to <code class="highlighter-rouge">machine/log</code> and <code class="highlighter-rouge">installer/log</code> methods. So, received installers logs will be automatically propagated to subscribed clients. If an infrastructure wants to propagate machine logs it’s enough to propagate <code class="highlighter-rouge">MachineLogEvent</code> via <code class="highlighter-rouge">EventService</code>.</p>

    <p>Setting up a new endpoint can be useful to remove load from master since there can be a lot of output produced by runtime.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">#getRuntime</code> method that returns a runtime.</p>
  </li>
</ul>

<h2 id="internalruntime">InternalRuntime</h2>

<p>The main piece of work should be done while implementing of start and stop of <code class="highlighter-rouge">InternalRuntime</code> (<code class="highlighter-rouge">#internalStart</code> and <code class="highlighter-rouge">#internalStop</code> methods).
After runtime start, it should be fully ready to be used by clients. Start of runtime includes two major actions: <strong>machines start</strong> and <strong>launching agents</strong>.</p>

<p>Starting of machines is an exceptionally infrastructure specific process. There is only one declared thing that is related to machine life cycle: Infrastructure may publish <a href="https://github.com/eclipse/che/blob/master/wsmaster/che-core-api-workspace-shared/src/main/java/org/eclipse/che/api/workspace/shared/dto/event/MachineStatusEvent.java#L25">machine statuses events</a>. There are four possible values for machine status:</p>

<ul>
  <li><strong><em>STARTING</em></strong> - machine is starting;</li>
  <li><strong><em>RUNNING</em></strong> - machine is running, note that it says nothing about servers statuses and machine can be not ready for using by clients;</li>
  <li><strong><em>STOPPED</em></strong> - machine is not running;</li>
  <li><strong><em>FAILED</em></strong> - machine failed to start or crashed while running.</li>
</ul>

<h2 id="installers">Installers</h2>

<p>As to launching of agents, Che offers an out-of-the-box feature that automates this process. So, it can be done with installers which in fact are shell scripts that should be executed to install some software and dependencies, and launch it if needed. A <strong>bootstrapper</strong> can be used to execute installers scripts.</p>

<p><strong>Bootstrapper</strong> is a binary file which can execute installers scripts and wait until the corresponding servers are accessible.  To launch machine with agents via a bootstrapper, extend <code class="highlighter-rouge">AbstractBootstrapper</code> and implement <code class="highlighter-rouge">#doBootstrapAsync</code> method with the following steps:</p>

<ul>
  <li>
    <p>Provide binary file of bootstrapper into a machine. Bootstrapper binaries are hosted by Che Server and can be downloaded by the following link <code class="highlighter-rouge">http://${CHE_HOST}:${CHE_PORT}/agent-binaries/linux_amd64/bootstrapper/bootstrapper</code>. Or it can be provided in any another way if infrastructure is able put something into machine (exec, mount etc).</p>
  </li>
  <li>
    <p>The second step is providing a config file for a bootstrapper (inject it into machine in a way that an infrastructure allows). It must contain an ordered list of <a href="https://github.com/eclipse/che/blob/master/wsmaster/che-core-api-installer-shared/src/main/java/org/eclipse/che/api/installer/shared/model/Installer.java">installers</a> configs in a json format. Installers will be launched in the specified order and it is needed for resolving dependencies between installers. Note that <a href="https://github.com/eclipse/che/blob/master/wsmaster/che-core-api-workspace/src/main/java/org/eclipse/che/api/workspace/server/spi/environment/InternalMachineConfig.java#L76">InternalMachineConfig#getInstallers</a> methods returns already ordered installers list.</p>
  </li>
  <li>
    <p>Finally, launching bootstrapper with the corresponding parameters. Bootstrapper requires the following parameters to be specified as start arguments:</p>

    <ul>
      <li><strong><em>machine-name</em></strong> - machine name where this particular bootstrapper is running.</li>
      <li><strong><em>runtime-id</em></strong> - runtime identifier in format ‘workspace:environment:owner’.</li>
      <li><strong><em>push-endpoint</em></strong> - a WebSocket endpoint where to push statuses.</li>
      <li><strong><em>push-logs-endpoint</em></strong> - a WebSocket endpoint where to push logs.</li>
    </ul>

    <p>The following parameters are optional and there is default behavior when they are missing:</p>

    <ul>
      <li><strong><em>-installer-timeout</em></strong> - time(in seconds) given for one installer to complete its installation. If installation is not finished in time it will be interrupted. Default value 120 seconds (3 minutes);</li>
      <li><strong><em>server-check-period</em></strong> - time(in seconds) between servers availability checks. Once servers for an installer are available, checks are stopped. The default value is 3 seconds;</li>
      <li><strong><em>file</em></strong> - configuration file path. Default value - <code class="highlighter-rouge">config.json</code>;</li>
      <li><strong><em>logs-endpoint-reconnect-period</em></strong> - time(in seconds) between attempts to reconnect to push-logs-endpoint. Bootstrapper tries to reconnect to push-logs-endpoint when previously established connection lost. Default value - 10 seconds.</li>
    </ul>
  </li>
</ul>

<p>Skeletal implementation of <code class="highlighter-rouge">AbstractBootstrapper</code> should look like the following sample:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">eclipse</span><span class="o">.</span><span class="na">che</span><span class="o">.</span><span class="na">workspace</span><span class="o">.</span><span class="na">infrastructure</span><span class="o">.</span><span class="na">dummy</span><span class="o">.</span><span class="na">bootstrapper</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">...</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyBootstrapper</span> <span class="kd">extends</span> <span class="n">AbstractBootstrapper</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Gson</span> <span class="n">GSON</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GsonBuilder</span><span class="o">().</span><span class="na">disableHtmlEscaping</span><span class="o">().</span><span class="na">create</span><span class="o">();</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">machineName</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">RuntimeIdentity</span> <span class="n">runtimeIdentity</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Installer</span><span class="o">&gt;</span> <span class="n">installers</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">serverCheckPeriodSeconds</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">installerTimeoutSeconds</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">installerWebsocketEndpoint</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">outputWebsocketEndpoint</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">MyBootstrapper</span><span class="o">(</span>
      <span class="nd">@Assisted</span> <span class="n">String</span> <span class="n">machineName</span><span class="o">,</span>
      <span class="nd">@Assisted</span> <span class="n">RuntimeIdentity</span> <span class="n">runtimeIdentity</span><span class="o">,</span>
      <span class="nd">@Assisted</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Installer</span><span class="o">&gt;</span> <span class="n">installers</span><span class="o">,</span>
      <span class="n">EventService</span> <span class="n">eventService</span><span class="o">,</span>
      <span class="nd">@Named</span><span class="o">(</span><span class="s">"che.websocket.endpoint"</span><span class="o">)</span> <span class="n">String</span> <span class="n">cheWebsocketEndpoint</span><span class="o">,</span>
      <span class="nd">@Named</span><span class="o">(</span><span class="s">"che.infra.dummy.output_endpoint"</span><span class="o">)</span> <span class="n">String</span> <span class="n">myOutputEndpoint</span><span class="o">,</span>
      <span class="nd">@Named</span><span class="o">(</span><span class="s">"che.infra.dummy.bootstrapper.timeout_min"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">bootstrappingTimeoutMinutes</span><span class="o">,</span>
      <span class="nd">@Named</span><span class="o">(</span><span class="s">"che.infra.dummy.bootstrapper.installer_timeout_sec"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">installerTimeoutSeconds</span><span class="o">,</span>
      <span class="nd">@Named</span><span class="o">(</span><span class="s">"che.infra.dummy.bootstrapper.server_check_period_sec"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">serverCheckPeriodSeconds</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">machineName</span><span class="o">,</span> <span class="n">runtimeIdentity</span><span class="o">,</span> <span class="n">bootstrappingTimeoutMinutes</span><span class="o">,</span> <span class="n">myOutputEndpoint</span><span class="o">,</span>
        <span class="n">cheWebsocketEndpoint</span><span class="o">,</span> <span class="n">eventService</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">machineName</span> <span class="o">=</span> <span class="n">machineName</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">runtimeIdentity</span> <span class="o">=</span> <span class="n">runtimeIdentity</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">installers</span> <span class="o">=</span> <span class="n">installers</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">serverCheckPeriodSeconds</span> <span class="o">=</span> <span class="n">serverCheckPeriodSeconds</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">installerTimeoutSeconds</span> <span class="o">=</span> <span class="n">installerTimeoutSeconds</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">installerWebsocketEndpoint</span> <span class="o">=</span> <span class="n">cheWebsocketEndpoint</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">outputWebsocketEndpoint</span> <span class="o">=</span> <span class="n">myOutputEndpoint</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doBootstrapAsync</span><span class="o">(</span><span class="n">String</span> <span class="n">installerWebsocketEndpoint</span><span class="o">,</span> <span class="n">String</span> <span class="n">outputWebsocketEndpoint</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">InfrastructureException</span> <span class="o">{</span>
    <span class="c1">// inject bootstrapper binaries</span>

    <span class="c1">// make it executable</span>

    <span class="n">String</span> <span class="n">configJson</span> <span class="o">=</span> <span class="n">GSON</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">installers</span><span class="o">);</span>
    <span class="c1">// inject config.json file</span>

    <span class="c1">// launch bootstrapper with the corresponding</span>
    <span class="c1">// configuration parameters</span>
    <span class="c1">//</span>
    <span class="c1">// ./bootstrapper -machine-name $machineName</span>
    <span class="c1">//                -runtime-id + String.format("%s:%s:%s",</span>
    <span class="c1">//                                            runtimeIdentity.getWorkspaceId(),</span>
    <span class="c1">//                                            runtimeIdentity.getEnvName(),</span>
    <span class="c1">//                                            runtimeIdentity.getOwner()</span>
    <span class="c1">//                -push-endpoint $installerWebsocketEndpoint</span>
    <span class="c1">//                -push-logs-endpoint $outputWebsocketEndpoint</span>
    <span class="c1">//                -server-check-period $serverCheckPeriodSeconds</span>
    <span class="c1">//                -installer-timeout $installerTimeoutSeconds</span>
    <span class="c1">//                -file $pathToConfigFileHere</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>When it is implemented <code class="highlighter-rouge">InternalRuntime</code> can easily use it in the following way:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyInternalRuntime</span> <span class="kd">extends</span> <span class="n">InternalRuntime</span><span class="o">&lt;</span><span class="n">MyRuntimeContext</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doBootstrap</span><span class="o">(</span><span class="n">String</span> <span class="n">machineName</span><span class="o">,</span> <span class="n">InternalMachineConfig</span> <span class="n">machineConfig</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">InfrastructureException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
      <span class="n">MyBootstrapper</span> <span class="n">myBootstrapper</span> <span class="o">=</span>
          <span class="n">myBootstrapperFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
              <span class="n">machineName</span><span class="o">,</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getIdentity</span><span class="o">(),</span> <span class="n">machineConfig</span><span class="o">.</span><span class="na">getInstallers</span><span class="o">());</span>

      <span class="n">myBootstrapper</span><span class="o">.</span><span class="na">bootstrap</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="servers">Servers</h2>

<p>See: <a href="servers.html">Servers</a></p>

<p>Machine configuration contains servers configuration that will be launched inside it. Servers can be embedded into a machine or launched by installers. If an application has more than one endpoint (like http and websocket, or the same protocol by different paths) it can declare different servers. There are two kinds of servers:</p>

<ul>
  <li>
    <p>Internal servers which are available only for other machines of a workspace;</p>
  </li>
  <li>
    <p>Public server which are available for all clients.</p>
  </li>
</ul>

<p>Public servers should be protected with authentication since they are publicly accessible. Internal servers don’t require any authentication since they must be accessible only for other machines. So, servers configs have the following format:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/** Configuration of server that can be started inside of machine. */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ServerConfig</span> <span class="o">{</span>
  <span class="cm">/**
   * Port used by server. It may contain protocol(tcp or udp) after '/' symbol. If protocol is
   * missing tcp will be used by default.
   * Example: '8080/tcp', '8080/udp', '8080'.
   */</span>
  <span class="n">String</span> <span class="nf">getPort</span><span class="o">();</span>

  <span class="cm">/**
   * Protocol for configuring preview url of this server.
   * Example: 'http', 'https', 'tcp', 'udp', 'ws', 'wss'.
   */</span>
  <span class="n">String</span> <span class="nf">getProtocol</span><span class="o">();</span>

  <span class="cm">/** Path used by server. */</span>
  <span class="nd">@Nullable</span>
  <span class="n">String</span> <span class="nf">getPath</span><span class="o">();</span>

  <span class="cm">/** Attributes of the server */</span>
  <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">getAttributes</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>There is an attribute of which has name <code class="highlighter-rouge">internal</code> and boolean value which indicates whether server should be internal or public. If the attribute is missing or its value differs from “true” than server is treated as public. Infrastructure is responsible for propagated ports of servers in different ways depending on whether or not the server is internal.
Port is a machine port which will be used by a server and should be propagated by infrastructure for the clients. The way of propagating of machine port is infrastructure specific. To interact with servers Che clients use servers provided by an Infrastructure.
So, the server object has the following format:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Server</span> <span class="o">{</span>
  <span class="cm">/** Returns URL exposing the server */</span>
  <span class="n">String</span> <span class="nf">getUrl</span><span class="o">();</span>

  <span class="cm">/** Returns the status */</span>
  <span class="n">ServerStatus</span> <span class="nf">getStatus</span><span class="o">();</span>

  <span class="cm">/** Returns attributes of the server with some metadata */</span>
  <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">getAttributes</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Attributes from server configs should be propagated to servers.</p>

<p>The server URL should be evaluated by Infrastructure with <code class="highlighter-rouge">protocol</code> and <code class="highlighter-rouge">path</code> from server config, while <code class="highlighter-rouge">host name</code> and <code class="highlighter-rouge">port</code> values depending on the way in which machines ports are propagated by an infrastructure.
Note that server URL can be rewritten with <code class="highlighter-rouge">URLRewriter</code> by abstract <code class="highlighter-rouge">InternalRuntime</code>, so clients will get modified URL. It is used when Che machines supposed to be accessible via reverse Proxy.</p>

<p>As to server statuses they are provided by Infrastructure. There are three possible values for them:</p>

<ul>
  <li>RUNNING is returned when server is up and running;</li>
  <li>STOPPED is returned when server is not running;</li>
  <li>UNKNOWN there is no information about server status.</li>
</ul>

<p>Checking of servers statuses can be performed in infrastructure specific way. Or Workspace API provides out of box server checkers which can be used by Infrastructure. Now there are servers checks only for most critical servers for Che clients: wsagent, terminal, exec. It can be used by Runtime while starting and waiting until servers are available in the following way:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.eclipse.che.api.workspace.server.hc.ServersChecker</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.che.api.workspace.server.hc.ServersCheckerFactory</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">class</span> <span class="nc">MyInternalRuntime</span> <span class="o">{</span>
  <span class="o">...</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doWaitServersRunning</span><span class="o">(</span><span class="n">String</span> <span class="n">machineName</span><span class="o">,</span> <span class="n">InternalMachineConfiug</span> <span class="n">machineConfig</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">InfrastructureException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
    <span class="n">ServersChecker</span> <span class="n">readinessChecker</span> <span class="o">=</span> <span class="n">serverCheckerFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">getContext</span><span class="o">().</span><span class="na">getIdentity</span><span class="o">(),</span>
                                                      <span class="n">machineName</span><span class="o">,</span> <span class="n">machine</span><span class="o">.</span><span class="na">getServers</span><span class="o">());</span>
    <span class="n">readinessChecker</span><span class="o">.</span><span class="na">startAsync</span><span class="o">((</span><span class="n">serverRef</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="c1">// update server state to RUNNING</span>
      <span class="n">sendRunningServerEvent</span><span class="o">(</span><span class="n">machineName</span><span class="o">,</span> <span class="n">serverRef</span><span class="o">);</span>
    <span class="o">});</span>
    <span class="n">readinessChecker</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In addition there are server probes which may be scheduled to continuously checks server liveness. Here is an example of how to do this:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.eclipse.che.api.workspace.server.hc.probe.ProbeResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.che.api.workspace.server.hc.probe.ProbeResult.ProbeStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.che.api.workspace.server.hc.probe.ProbeScheduler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.che.api.workspace.server.hc.probe.WorkspaceProbesFactory</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">class</span> <span class="nc">MyInternalRuntime</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">ProbeScheduler</span> <span class="n">probeScheduler</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">WorkspaceProbesFactory</span> <span class="n">probesFactory</span><span class="o">;</span>
  <span class="o">...</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doScheduleServersLivenessProbes</span><span class="o">(</span><span class="n">String</span> <span class="n">machineName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InfrastructureException</span> <span class="o">{</span>
    <span class="n">RuntimeIdentity</span> <span class="n">identity</span> <span class="o">=</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getIdentity</span><span class="o">();</span>
    <span class="n">probeScheduler</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span>
      <span class="n">probesFactory</span><span class="o">.</span><span class="na">getProbes</span><span class="o">(</span><span class="n">identity</span><span class="o">.</span><span class="na">getWorkspaceId</span><span class="o">(),</span> <span class="n">machineName</span><span class="o">,</span> <span class="cm">/*resolved machine servers should be here instead of empty map*/</span> <span class="n">emptyMap</span><span class="o">()),</span>
      <span class="k">new</span> <span class="nf">ServerLivenessHandler</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">class</span> <span class="nc">ServerLivenessHandler</span> <span class="kd">implements</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">ProbeResult</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accept</span><span class="o">(</span><span class="n">ProbeResult</span> <span class="n">probeResult</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">String</span> <span class="n">machineName</span> <span class="o">=</span> <span class="n">probeResult</span><span class="o">.</span><span class="na">getMachineName</span><span class="o">();</span>
      <span class="n">String</span> <span class="n">serverName</span> <span class="o">=</span> <span class="n">probeResult</span><span class="o">.</span><span class="na">getServerName</span><span class="o">();</span>
      <span class="n">ProbeStatus</span> <span class="n">probeStatus</span> <span class="o">=</span> <span class="n">probeResult</span><span class="o">.</span><span class="na">getStatus</span><span class="o">();</span>
      <span class="n">Server</span> <span class="n">server</span> <span class="o">=</span> <span class="cm">/*assign server which has name serverName to which probe is related instead of null*/</span> <span class="kc">null</span><span class="o">;</span>
      <span class="n">ServerStatus</span> <span class="n">oldServerStatus</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">getStatus</span><span class="o">();</span>
      <span class="n">ServerStatus</span> <span class="n">serverStatus</span><span class="o">;</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">probeStatus</span> <span class="o">==</span> <span class="n">ProbeStatus</span><span class="o">.</span><span class="na">FAILED</span> <span class="o">&amp;&amp;</span> <span class="n">oldServerStatus</span> <span class="o">==</span> <span class="n">ServerStatus</span><span class="o">.</span><span class="na">RUNNING</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">serverStatus</span> <span class="o">=</span> <span class="n">ServerStatus</span><span class="o">.</span><span class="na">STOPPED</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">probeStatus</span> <span class="o">==</span> <span class="n">ProbeStatus</span><span class="o">.</span><span class="na">PASSED</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">oldServerStatus</span> <span class="o">!=</span> <span class="n">ServerStatus</span><span class="o">.</span><span class="na">RUNNING</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">serverStatus</span> <span class="o">=</span> <span class="n">ServerStatus</span><span class="o">.</span><span class="na">RUNNING</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="c1">// set new status serverStatus into machine with name machineName</span>

      <span class="c1">// send event about changing server status</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="volumes">Volumes</h2>

<p>A <a href="volumes.html">volume</a> is a persistent storage that can be used for sharing data between machines of a workspace or for saving data persistently. Volumes field in a machine configuration is a map where key is volume name and value is volume itself. For now, volume object has only one field <code class="highlighter-rouge">path</code>. It’s an absolute path where volume should be mounted in the machine.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"myMachine"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="err">...</span><span class="w">
     </span><span class="s2">"volumes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="s2">"maven_repo"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/home/user/.m2/repository"</span><span class="w">
       </span><span class="p">}</span><span class="w">
     </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Note that if a volume with the same name is used in different machines then the same volume should be shared between machines.</p>

<p>Infrastructure must implement supporting of volumes in its own way.</p>

<h2 id="workspace-start-interruption">Workspace Start Interruption</h2>

<p>Workspace API allows users to stop workspaces that are <strong><em>STARTING</em></strong>, but whether they will interrupt the launch of the workspace or not, depends on the implementation of the infrastructure. So <code class="highlighter-rouge">InternalRuntime</code> should expect that <code class="highlighter-rouge">internalStop</code> method may be called when <code class="highlighter-rouge">internalStart</code> hasn’t finished its work yet. Then <code class="highlighter-rouge">InternalRuntime</code> may interrupt runtime start or throw an exception if stopping of a workspace with a <strong><em>STARTING</em></strong> status is not supported by an infrastructure.</p>

<h2 id="runtimes-recovering">Runtimes Recovering</h2>

<p>Workspace API allows Infrastructure to pick up running runtime while getting it from context. It allows recovering running runtime when workspace master crashed, or restart/reconfigure/update workspace master without workspaces stopping.</p>

<h2 id="skeletal-implementation">Skeletal Implementation</h2>

<p>The full skeletal implementation is located in the following <a href="https://github.com/codenvy/che-infra-sample">repository</a>.</p>



    <div class="tags">
        
    </div>

<!-- 
 -->

</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               01/30/18 <br /> Eclipse Che: Eclipse Public License - v 1.0. <br />
 Site last generated: Jan 30, 2018 <br />
<p><img src="images/che_logo.png" alt="Eclise Che"/></p>
                </div>
            </div>
</footer>




    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>
