<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" dev docs">
<title>SPI&#58 Implementation | Eclipse Che Documentation</title>
<link rel="stylesheet" href="css/syntax.css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="css/theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="che" href="http://0.0.0.0:4000/feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Eclipse Che Documentation</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->




                
                
                
                <li><a href="news">Release Notes</a></li>
                
                
                
                <li><a href="https://github.com/eclipse/che" target="_blank">Source Code</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Get Support<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="https://github.com/eclipse/che/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc+label%3Akind%2Fbug" target="_blank">Known Bugs</a></li>
                        
                        
                        
                        <li><a href="https://github.com/eclipse/che/issues/new" target="_blank">File an Issue</a></li>
                        
                        
                        
                        <li><a href="https://stackoverflow.com/questions/tagged/eclipse-che" target="_blank">Che on StackOverflow</a></li>
                        
                        
                    </ul>
                </li>
                
                
                <!-- 
			<li>



  <a class="email" title="Submit feedback" href="#" onclick="javascript:window.location='mailto:?subject= feedback&body=I have some feedback about the SPI&#58 Implementation page: ' + window.location.href;"><i class="fa fa-envelope-o"></i> Feedback</a>

</li>
 -->
		
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="SPI&amp;#58 Implementation">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
  <li class="sidebarTitle"> </li>
  
  
  
      
  
  <li>
      <a href="#">Overview</a>
      <ul>
          
          
          
          <li><a href="index.html">What Is Eclipse Che?</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Setup</a>
      <ul>
          
          
          
          <li><a href="single_multi_user.html">Single vs Multi-User</a></li>
          
          
          
          
          
          
          <li><a href="docker_openshift.html">Docker vs OpenShift</a></li>
          
          
          
          
          
          
          <li><a href="docker.html">Single-User on Docker</a></li>
          
          
          
          
          
          
          <li><a href="openshift.html">Single-User on OpenShift</a></li>
          
          
          
          
          
          
          <li><a href="multi-user-docker.html">Multi-User on Docker</a></li>
          
          
          
          
          
          
          <li><a href="multi-user-openshift.html">Multi-User on OpenShift</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Configuration</a>
      <ul>
          
          
          
          <li><a href="docker-config.html">Configuration on Docker</a></li>
          
          
          
          
          
          
          <li><a href="cli-reference.html">CLI Reference</a></li>
          
          
          
          
          
          
          <li><a href="openshift-config.html">Configuration on OpenShift</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Framework</a>
      <ul>
          
          
          
          <li><a href="framework_overview.html">Overview</a></li>
          
          
          
          
          
          
          <li><a href="che_master.html">Master</a></li>
          
          
          
          
          
          
          <li><a href="rest_api.html">REST API</a></li>
          
          
          
          
          
          
          <li><a href="dao.html">Persistence, DAO</a></li>
          
          
          
          
          
          
          <li><a href="registry.html">Registry</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Workspaces</a>
      <ul>
          
          
          
          <li><a href="what_are_workspaces.html">Model</a></li>
          
          
          
          
          
          
          <li><a href="workspaces_rest_api.html">REST API</a></li>
          
          
          
          
          
          
          <li><a href="environments.html">Environments</a></li>
          
          
          
          
          
          
          <li><a href="servers.html">Servers</a></li>
          
          
          
          
          
          
          <li><a href="recipes.html">Recipes</a></li>
          
          
          
          
          
          
          <li><a href="installers.html">Installers</a></li>
          
          
          
          
          
          
          <li><a href="volumes.html">Volumes</a></li>
          
          
          
          
          
          
          <li><a href="env_variables.html">Env Variables</a></li>
          
          
          
          
          
          
          <li><a href="projects.html">Projects</a></li>
          
          
          
          
          
          
          <li><a href="workspaces_troubleshooting.html">Troubleshooting</a></li>
          
          
          
          
          
          
          <li><a href="workspace_data_model.html">Workspace Data Model</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Workspace Delivery</a>
      <ul>
          
          
          
          <li><a href="creating_starting_workspaces.html">Creating and starting Workspaces</a></li>
          
          
          
          
          
          
          <li><a href="factories_getting_started.html">Factories Getting Started</a></li>
          
          
          
          
          
          
          <li><a href="creating_factories.html">Creating Factories</a></li>
          
          
          
          
          
          
          <li><a href="factories_json_reference.html">Factories JSON Reference</a></li>
          
          
          
          
          
          
          <li><a href="stacks.html">Stacks</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">IDE and Editor</a>
      <ul>
          
          
          
          <li><a href="ide_projects.html">Projects</a></li>
          
          
          
          
          
          
          <li><a href="editor_code_assistance.html">Editor and Code-Assistance</a></li>
          
          
          
          
          
          
          <li><a href="dependency_management.html">Dependency Management</a></li>
          
          
          
          
          
          
          <li><a href="commands_ide_macro.html">Commands and IDE Macros</a></li>
          
          
          
          
          
          
          <li><a href="version_control.html">Version Control</a></li>
          
          
          
          
          
          
          <li><a href="debug.html">Debug</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Multi-User</a>
      <ul>
          
          
          
          <li><a href="user-management.html">Authentication and Authorization</a></li>
          
          
          
          
          
          
          <li><a href="permissions.html">Permissions</a></li>
          
          
          
          
          
          
          <li><a href="multiuser_api.html">REST API</a></li>
          
          
          
          
          
          
          <li><a href="organizations.html">Organizations on UD</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Infrastructure and SPI</a>
      <ul>
          
          
          
          <li><a href="spi_overview.html">Overview and Motivation</a></li>
          
          
          
          
          
          
          <li class="active"><a href="spi_implementation.html">Implementation Notes</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Extensibility</a>
      <ul>
          
          
          
          <li><a href="framework.html">Framework</a></li>
          
          
          
          
          
          
          <li><a href="che_in_che_quickstart.html">Quick-Start&#58 Your First Plugin</a></li>
          
          
          
          
          
          
          <li><a href="ide-extensions-gwt.html">GWT IDE Extensions</a></li>
          
          
          
          
          
          
          <li><a href="ide-extensions-js.html">JavaScript IDE Extensions</a></li>
          
          
          
          
          
          
          <li><a href="server-side-extensions.html">Server Side Agents</a></li>
          
          
          
          
          
          
          <li><a href="project_types.html">Project Types</a></li>
          
          
          
          
          
          
          <li><a href="language_servers.html">Language Servers</a></li>
          
          
          
          
          
          
          <li><a href="parts.html">IDE UI&#58 Parts</a></li>
          
          
          
          
          
          
          <li><a href="actions.html">IDE UI&#58 Actions</a></li>
          
          
          
          
          
          
          <li><a href="editor.html">IDE UI&#58 Editor</a></li>
          
          
          
          
          
          
          <li><a href="themes.html">IDE UI&#58 Themes</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Dev Essentials</a>
      <ul>
          
          
          
          <li><a href="guice.html">Dependency Injection</a></li>
          
          
          
          
          
          
          <li><a href="dto.html">Transport&#58 DTO</a></li>
          
          
          
          
          
          
          <li><a href="assemblies.html">Assemblies</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block:
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
         -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>

            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">SPI&#58 Implementation</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.
$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2' });
/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top
  $(window).scrollTop(scroll_target - 10);
  return false
})

});
</script>

<div id="toc"></div>

    


    <!-- 


     -->

  
<h2 id="components-overview">Components Overview</h2>

<p>TODO A diagram can be useful here.</p>

<p><a href="https://github.com/sleshchenko/che-dummy-infra">TODO Add dummy implementation of Infrastructure</a></p>

<ul>
  <li><a href="https://github.com/eclipse/che/blob//wsmaster/che-core-api-workspace/src/main/java/org/eclipse/che/api/workspace/server/spi/RuntimeInfrastructure.java">RuntimeInfrastructure</a> is a starting point that has two obligations:
    <ul>
      <li>provides meta information about infrastructure like name and types of recipes which are supported;</li>
      <li>provides an interface for creation to RuntimeContext.</li>
    </ul>
  </li>
  <li>
    <p><a href="https://github.com/eclipse/che/blob//wsmaster/che-core-api-workspace/src/main/java/org/eclipse/che/api/workspace/server/spi/RuntimeContext.java">RuntimeContext</a> holds information that can be used by InternalRuntime.</p>
  </li>
  <li>
    <p><a href="https://github.com/eclipse/che/blob//wsmaster/che-core-api-workspace/src/main/java/org/eclipse/che/api/workspace/server/spi/InternalRuntime.java">InternalRuntime</a> describes particular runtime and provides an interface for interacting with it like starting, stopping.</p>
  </li>
  <li>
    <p><a href="https://github.com/eclipse/che/blob//wsmaster/che-core-api-workspace/src/main/java/org/eclipse/che/api/workspace/server/spi/environment/InternalEnvironment.java#L32">InternalEnvironment</a> holds internal representations of environment configuration.</p>
  </li>
  <li><a href="https://github.com/eclipse/che/blob//wsmaster/che-core-api-workspace/src/main/java/org/eclipse/che/api/workspace/server/spi/environment/InternalEnvironmentFactory.java#L45">InternalEnvironmentFactory</a> creates a valid InternalEnvironment based on the specified workspace configuration and recipe.</li>
</ul>

<h2 id="exceptions">Exceptions</h2>

<p>There are three types of exception which can be thrown by Infrastructure components:
ValidationException should be thrown when error occurs because of wrong data provided by user;
InternalInfrastructureException should be thrown when unexpected error occurs and a user doesn’t have an ability to fix it and Che Server administrator should take a look at it;
InfrastructureException should be thrown in other cases.</p>

<h2 id="events">Events</h2>
<p>Infrastructure should inform Workspace API about progress of starting/stopping a workspace with publishing of events. Events are DTOs objects and can be created with DtoFactory. Server implementations are provided by workspace-api module. Infrastructure should publish them by EventService. Information about particular events and when they should be thrown are listed below.</p>

<h2 id="implementing-own-infrastructure">Implementing own infrastructure</h2>

<p>The first thing that should be decided is which environments will be supported by new infrastructure and which recipes will be supported. Che has four recipes out of the box which can be used: dockerfile, dockerimage, compose, openshift. If a developer wants to support own recipe type the corresponding InternalEnvironmentFactory should be bound with a MapBinder with unique String key that contains recipe type, like:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="n">MapBinder</span><span class="o">.</span><span class="na">newMapBinder</span><span class="o">(</span><span class="n">binder</span><span class="o">(),</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">InternalEnvironmentFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                    <span class="o">.</span><span class="na">addBinding</span><span class="o">(</span><span class="s">"myRecipe"</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">SubclassOfInternalEnvironmentFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div>

<p>When the issue with the supported environments is solved the next step is implementing own RuntimeInfrastructure, RuntimeContext, InternalRuntime which are strongly connected.</p>

<p>So, <code class="highlighter-rouge">RuntimeInfrastructure</code> should create the RuntimeContext according to the specified InternalEnvironment. Before context creation, RuntimeInfrastructure may need somehow customize InternalEnvironment, like modifying original recipes objects according to machines configuration (like exposing ports required for configured servers, or setting memory limit according to machine configuration). This step is called Runtime Context preparing.</p>

<p><strong>Implementation of RuntimeContext</strong> should provide two methods:</p>

<ul>
  <li><code class="highlighter-rouge">#getOutputChannel</code> method that returns output channel for a particular runtime. The output channel is a WebSocket endpoint where runtime output (machine logs can be received by clients. It can be the same as existing master websocket endpoint configured with <code class="highlighter-rouge">che.websocket.endpoint</code> property. This endpoint will republish the corresponding output events to subscribed clients. Since there can be a lot of output produced by runtime it can be useful to setup the separated endpoint to remove load from master. So infrastructure can do it.</li>
</ul>

<p>TODO Paste link to JSON RPC doc here</p>

<p>TODO Add information about published objects</p>

<p>TODO Add information about JSON RPC methods</p>

<ul>
  <li><code class="highlighter-rouge">#getRuntime</code> method that returns runtime itself.</li>
</ul>

<p>The main piece of work should be done while implementing of start and stop of <code class="highlighter-rouge">InternalRuntime</code>.
After a start of runtime, it should be fully ready for use by clients. Start of runtime includes two major actions: machines starting and agents launching. Starting of machines is fully infrastructure specific process. The only one obligation for Infrastructure related to machine life cycle is publishing of machine statuses. There are four possible values for
machine status:</p>

<ul>
  <li>STARTING - machine is starting;</li>
  <li>RUNNING - machine is running;</li>
  <li>STOPPED - machine is not running;</li>
  <li>FAILED - machine failed to start or crashed while running.</li>
</ul>

<p>As for launching of agents, there is feature out of the box for performing it or infrastructure can perform it in its own way. So it can be done with installers which in fact are shell scripts which should be performed for launching the declared servers. Execution of these scripts can be done by infrastructure itself or bootstrapper can be used.</p>

<p>Bootstrapper is a binary file which can execute installers scripts and wait until the corresponding servers are accessible. To perform machine launching of machine’s installers by bootstrapper it is required to extend <code class="highlighter-rouge">AbstractBootstrapper</code> and implement <code class="highlighter-rouge">#doBootstrapAsync</code> method with the following steps:</p>

<ul>
  <li>
    <p>Provide binary file of bootstrapper into a machine. Bootstrapper binaries are hosted by Che Server and can be downloaded by the following link <code class="highlighter-rouge">http://${CHE_HOST}:${CHE_PORT}/agent-binaries/linux_amd64/bootstrapper/bootstrapper</code>. Or it can be provided in any another way if infrastructure is able to inject something into machine.</p>
  </li>
  <li>The second step is providing a config file for bootstrapper into machine. It must contain list of installers configs in json format.</li>
  <li>
    <p>Finally, launching of bootstrapper with the corresponding parameters. Bootstrapper requires the following parameters to be specified as launching arguments:</p>
  </li>
  <li>
    <p>machine-name - the name of the machine in which this bootstrapper is running.</p>
  </li>
  <li>
    <p>runtime-id - the identifier of the runtime in format ‘workspace:environment:owner’.</p>
  </li>
  <li>
    <p>push-endpoint - a WebSocket endpoint where to push statuses.</p>
  </li>
  <li>push-logs-endpoint - a WebSocket endpoint where to push logs.</li>
</ul>

<p>The following parameters are optional and there is default behavior when they are missing:
-installer-timeout - time(in seconds) given for one installer to complete its installation. If installation is not finished in time it will be interrupted. Default value 120 seconds (3 minutes);</p>

<ul>
  <li>
    <p>server-check-period - time(in seconds) between servers availability checks. Once servers for one installer available - checks stopped. Default value 3 seconds;</p>
  </li>
  <li>
    <p>file - configuration file path. Default value <code class="highlighter-rouge">config.json</code>;</p>
  </li>
  <li>
    <p>enable-auth - whether authenticate requests on workspace master before allowing them to proceed. By default the value from ‘CHE_AUTH_ENABLED’ environment variable is used or false if it is missing.</p>
  </li>
  <li>
    <p>logs-endpoint-reconnect-period - time(in seconds) between attempts to reconnect to push-logs-endpoint. Bootstrapper tries to reconnect to push-logs-endpoint when previously established connection lost. Default value 10 seconds.</p>
  </li>
</ul>

<p>TODO Add dummy implementation of bootstrapper and describe how and when it should be used.</p>

<p>If Infrastructure launches installers by itself it may publish the corresponding events about installing progress. There is <code class="highlighter-rouge">InstallerStatusEvent</code> for such purposes and it may be published when installing status changes. There are four values for installer statuses:</p>

<ul>
  <li>STARTING - installer is started;</li>
  <li>RUNNING - Installer successfully started, defined server is running;</li>
  <li>DONE - Installer successfully started, no servers was defined;</li>
  <li>FAILED - installation failed.</li>
</ul>

<h2 id="servers">Servers</h2>

<p>Machine configuration contains servers configuration that will be launched inside it. Servers can be embedded into a machine or launched by installers. There are two kinds of servers:</p>

<ul>
  <li>
    <p>Internal servers which are available only for other machines of a workspace;</p>
  </li>
  <li>
    <p>Public server which are available for all clients.</p>
  </li>
</ul>

<p>Public servers should be protected with authentication since they are publicly accessible. Internal servers don’t require any authentication since they must be accessible only for other machines. So, servers configs have the following format:</p>

<p>TODO Review it. Maybe there is a better way to provide format of the server configuration</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/** Configuration of server that can be started inside of machine. */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ServerConfig</span> <span class="o">{</span>
  <span class="cm">/**
   * Port used by server. It may contain protocol(tcp or udp) after '/' symbol. If protocol is
   * missing tcp will be used by default. Example:
   * &lt;ul&gt;
   *   &lt;li&gt;8080/tcp
   *   &lt;li&gt;8080/udp
   *   &lt;li&gt;8080
   * &lt;/ul&gt;
   */</span>
  <span class="n">String</span> <span class="nf">getPort</span><span class="o">();</span>

  <span class="cm">/**
   * Protocol for configuring preview url of this server. Example:
   *
   * &lt;ul&gt;
   *   &lt;li&gt;http
   *   &lt;li&gt;https
   *   &lt;li&gt;tcp
   *   &lt;li&gt;udp
   *   &lt;li&gt;ws
   *   &lt;li&gt;wss
   * &lt;/ul&gt;
   */</span>
  <span class="n">String</span> <span class="nf">getProtocol</span><span class="o">();</span>

  <span class="cm">/** Path used by server. */</span>
  <span class="nd">@Nullable</span>
  <span class="n">String</span> <span class="nf">getPath</span><span class="o">();</span>

  <span class="cm">/** Attributes of the server */</span>
  <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">getAttributes</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>There is an attribute of which has name <code class="highlighter-rouge">internal</code> and boolean value which indicates whether server should be internal or public. If the attribute is missing or its value differs from “true” then server treated as public. Infrastructure is responsible for propagated ports of servers in different ways depending on whether server is internal or not.
Port is a machine port which will be used by server and should be propagated by infrastructure for the clients. The way of propagating of machine port is infrastructure specific. To interact with servers Che clients use servers provided by an Infrastructure.
So, the server object has the following format:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Server</span> <span class="o">{</span>
  <span class="cm">/** Returns URL exposing the server */</span>
  <span class="n">String</span> <span class="nf">getUrl</span><span class="o">();</span>

  <span class="cm">/** Returns the status */</span>
  <span class="n">ServerStatus</span> <span class="nf">getStatus</span><span class="o">();</span>

  <span class="cm">/** Returns attributes of the server with some metadata */</span>
  <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">getAttributes</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Attributes from server configs should be propagated to servers. The server URL should be evaluated by Infrastructure in the following way - <code class="highlighter-rouge">{PROTOCOL}://{HOST_NAME}:{PORT}/{PATH}</code> where <code class="highlighter-rouge">{PROTOCOL}</code> and <code class="highlighter-rouge">{PATH}</code> are protocol and path of server which provided by config. {HOST_NAME} and {PORT} values depending on the way in which machines ports are propagated by an infrastructure.</p>

<p>As to server statuses they are provided by Infrastructure. There are three possible values for them:</p>

<ul>
  <li>RUNNING is returned when server is up and running;</li>
  <li>STOPPED is returned when server is not running;</li>
  <li>UNKNOWN there is no any information about server status.</li>
</ul>

<p>For now Docker and OpenShift infrastructures check status of 3 servers only:</p>
<ul>
  <li>wsagent</li>
  <li>terminal</li>
  <li>exec agent</li>
</ul>

<p>Checking of servers statuses can be performed in infrastructure specific way. Or Workspace API provides out of box server checkers which can be used by Infrastructure. Now there are servers checks only for most critical servers for Che clients: wsagent, terminal, exec. It can be used by Runtime while starting and waiting until servers will be available in the following way:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.eclipse.che.api.workspace.server.hc.ServersChecker</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.che.api.workspace.server.hc.ServersCheckerFactory</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">class</span> <span class="nc">MyInternalRuntime</span> <span class="o">{</span>
  <span class="o">...</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doWaitServersRunning</span><span class="o">(</span><span class="n">String</span> <span class="n">machineName</span><span class="o">,</span> <span class="n">InternalMachineConfiug</span> <span class="n">machineConfig</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">InfrastructureException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
    <span class="n">ServersChecker</span> <span class="n">readinessChecker</span> <span class="o">=</span> <span class="n">serverCheckerFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">getContext</span><span class="o">().</span><span class="na">getIdentity</span><span class="o">(),</span>
                                                      <span class="n">machineName</span><span class="o">,</span> <span class="n">machine</span><span class="o">.</span><span class="na">getServers</span><span class="o">());</span>
    <span class="n">readinessChecker</span><span class="o">.</span><span class="na">startAsync</span><span class="o">((</span><span class="n">serverRef</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="c1">// update server state to RUNNING</span>
      <span class="n">sendRunningServerEvent</span><span class="o">(</span><span class="n">machineName</span><span class="o">,</span> <span class="n">serverRef</span><span class="o">);</span>
    <span class="o">});</span>
    <span class="n">readinessChecker</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>TODO Continuous checking of servers statuses for wsagent, exec, terminal will be implemented soon https://github.com/eclipse/che/issues/7550</p>

<h2 id="volumes">Volumes</h2>

<p>One more thing that should be provided by Infrastructure is volumes support. Volume is a persistent storage that can be used for sharing data between machines of a workspace or for saving data persistently. Volumes field in a machine configuration is a map where key is volume name and value is volume itself. For now, volume object has only one field <code class="highlighter-rouge">path</code>. It’s absolute path where volume should be mounted in the machine.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="err">“myMachine”</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="err">...</span><span class="w">
     </span><span class="err">“volumes”</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="err">“maven_repo”</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="err">“path”</span><span class="p">:</span><span class="w"> </span><span class="err">“/home/user/.m</span><span class="mi">2</span><span class="err">/repository”</span><span class="w">
       </span><span class="p">}</span><span class="w">
     </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Note that if a volume with the same name is used in different machines then the same volume should be shared between machines.</p>

<h2 id="workspace-start-interruption">Workspace start interruption</h2>

<p>Workspace API allows users to stop workspaces that are STARTING, but whether they will interrupt the launch of the workspace or not, depends on the implementation of the infrastructure. So <code class="highlighter-rouge">InternalRuntime</code> should expect that <code class="highlighter-rouge">internalStop</code> method may be called when <code class="highlighter-rouge">internalStart</code> haven’t finished its work yet. Then <code class="highlighter-rouge">InternalRuntime</code> may interrupt runtime start  or throw an exception if stopping of a workspace while it’s STARTING is not supported by an infrastructure.</p>

<h2 id="runtimes-recovering">Runtimes recovering</h2>

<p>Workspace API allows Infrastructure to pick up running runtime while getting it from context. It allows to recover running runtime when workspace master crashed, or restart/reconfigure/update workspace master without workspaces stopping.</p>


    <div class="tags">
        
    </div>

<!-- 
 -->

</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               12/26/17 <br /> Eclipse Che: Eclipse Public License - v 1.0. <br />
 Site last generated: Dec 26, 2017 <br />
<p><img src="images/che_logo.png" alt="Eclise Che"/></p>
                </div>
            </div>
</footer>




    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>
